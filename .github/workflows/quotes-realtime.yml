name: Real-Time Quotes (Top 50 ETFs)

on:
  # Run every 30 minutes during market hours (8 AM - 6 PM ET, Mon-Fri)
  schedule:
    - cron: '0,30 8-18 * * 1-5'
    # Runs at 8:00, 8:30, 9:00, ... 18:00, 18:30 ET on weekdays
  # Allow manual trigger
  workflow_dispatch:

jobs:
  fetch-quotes:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Fetch Real-Time Quotes (Top 50)
        run: |
          echo "Fetching real-time quotes for top 50 ETFs..."
          echo "This may take up to 10 minutes due to rate limiting"
          echo ""

          # Make the request and save response to file
          response=$(curl -s -X GET \
            --max-time 600 \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            "https://etf-compass.vercel.app/api/cron/quotes?force=true")

          # Save response for debugging
          echo "$response" > /tmp/quotes_response.txt

          # Check if response is valid JSON
          if echo "$response" | jq empty 2>/dev/null; then
            echo "✅ Response is valid JSON"
            echo "$response" | jq .

            # Check status
            status=$(echo "$response" | jq -r '.status')
            if [ "$status" = "success" ] || [ "$status" = "partial" ]; then
              echo ""
              echo "✅ Quotes fetched successfully (or partially)"

              quotes=$(echo "$response" | jq -r '.results.quotes // "N/A"')
              echo "Quotes: $quotes"
            else
              echo ""
              echo "⚠️ Status: $status"
              skipped=$(echo "$response" | jq -r '.reason // empty')
              if [ -n "$skipped" ]; then
                echo "Reason: $skipped"
              fi
            fi
          else
            echo "⚠️ Response is not valid JSON (likely timeout)"
            echo "This usually means the request timed out but data may have been saved"
            echo ""
            echo "First 500 characters of response:"
            head -c 500 /tmp/quotes_response.txt
            echo ""
            echo ""
            echo "✅ NOT failing workflow - data was likely saved incrementally"
          fi

      - name: Verify Data in Cache
        run: |
          echo "Checking if data was saved to cache..."
          echo ""

          # Try to get a few sample ETFs to verify cache has data
          symbols=("VOO" "QQQ" "VTI" "SCHD")

          found=0
          total=${#symbols[@]}

          for symbol in "${symbols[@]}"; do
            response=$(curl -s -X GET \
              "https://etf-compass.vercel.app/api/etf/$symbol/quote")

            # Check if we got valid data
            if echo "$response" | jq -e '.midpoint' > /dev/null 2>&1; then
              midpoint=$(echo "$response" | jq -r '.midpoint')
              if [ "$midpoint" != "null" ] && [ "$midpoint" != "0" ]; then
                echo "✅ $symbol: \$$midpoint"
                ((found++))
              else
                echo "⚠️ $symbol: No data yet"
              fi
            else
              echo "❌ $symbol: Invalid response"
            fi
          done

          echo ""
          echo "Cache verification: $found/$total symbols have data"

          if [ $found -gt 0 ]; then
            echo "✅ Cache has data - cron job is working!"
          else
            echo "⚠️ Cache is empty - first run may still be in progress"
          fi
