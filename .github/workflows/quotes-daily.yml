name: Daily Quotes (All 200 ETFs)

on:
  # Run once daily at 6 AM ET (before market opens)
  schedule:
    - cron: '0 6 * * 1-5'
    # Runs at 6:00 AM ET on weekdays
  # Allow manual trigger
  workflow_dispatch:

jobs:
  fetch-daily-quotes:
    runs-on: ubuntu-latest
    # Set a longer timeout for fetching all 200 ETFs (~40 minutes)
    timeout-minutes: 50

    steps:
      - name: Fetch Daily Quotes (All 200)
        run: |
          echo "Fetching daily quotes for all 200 ETFs..."
          echo "This will take approximately 40 minutes due to rate limiting"
          echo "Vercel serverless timeout is 10 minutes, but data saves incrementally"
          echo ""

          # Make the request with a long timeout
          response=$(curl -s -X GET \
            --max-time 2400 \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            "https://etf-compass.vercel.app/api/cron/quotes-all?force=true")

          # Save response for debugging
          echo "$response" > /tmp/daily_quotes_response.txt

          # Check if response is valid JSON
          if echo "$response" | jq empty 2>/dev/null; then
            echo "✅ Response is valid JSON"
            echo "$response" | jq .

            # Check status
            status=$(echo "$response" | jq -r '.status')
            if [ "$status" = "success" ] || [ "$status" = "partial" ]; then
              echo ""
              echo "✅ Daily quotes fetched successfully (or partially)"

              quotes=$(echo "$response" | jq -r '.results.quotes // "N/A"')
              echo "Quotes: $quotes"
            else
              echo ""
              echo "⚠️ Status: $status"
              skipped=$(echo "$response" | jq -r '.reason // empty')
              if [ -n "$skipped" ]; then
                echo "Reason: $skipped"
              fi
            fi
          else
            echo "⚠️ Response is not valid JSON (likely timeout)"
            echo "This is expected - Vercel times out after ~10 minutes but data saves incrementally"
            echo ""
            echo "First 500 characters of response:"
            head -c 500 /tmp/daily_quotes_response.txt
            echo ""
            echo ""
            echo "✅ NOT failing workflow - data was saved incrementally before timeout"
          fi

      - name: Verify Data in Cache
        run: |
          echo "Verifying cache was populated..."
          echo ""

          # Check a diverse sample of ETFs
          symbols=("VOO" "QQQ" "VTI" "IWM" "GLD" "TLT" "XLE" "XLV")

          found=0
          total=${#symbols[@]}

          for symbol in "${symbols[@]}"; do
            response=$(curl -s -X GET \
              "https://etf-compass.vercel.app/api/etf/$symbol/quote")

            # Check if we got valid data
            if echo "$response" | jq -e '.midpoint' > /dev/null 2>&1; then
              midpoint=$(echo "$response" | jq -r '.midpoint')
              if [ "$midpoint" != "null" ] && [ "$midpoint" != "0" ]; then
                echo "✅ $symbol: \$$midpoint"
                ((found++))
              else
                echo "⚠️ $symbol: No data yet"
              fi
            else
              echo "❌ $symbol: Invalid response"
            fi

            # Small delay between checks
            sleep 1
          done

          echo ""
          echo "Cache verification: $found/$total sample symbols have data"

          if [ $found -ge 4 ]; then
            echo "✅ Cache is being populated successfully!"
          elif [ $found -gt 0 ]; then
            echo "⚠️ Partial data - job may still be running"
          else
            echo "❌ No data found - check the cron endpoint logs"
          fi
